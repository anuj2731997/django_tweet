{% extends "layout.html" %}
{% load static %}

{% block title %}{{ form.instance.pk|yesno:"Edit Tweet,Create Tweet" }}{% endblock %}

{% block content %}
<main class="max-w-3xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-semibold mb-6">
    {% if form.instance.pk %}Edit Tweet{% else %}Create Tweet{% endif %}
  </h1>

  
  {% if form.non_field_errors %}
    <div class="mb-4 rounded-md bg-red-50 border border-red-200 p-3 text-red-700">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-6 bg-white p-6 rounded-2xl shadow-sm">
    {% csrf_token %}

    {% for field in form.visible_fields %}
      <div>
        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ field.label }}{% if field.field.required %}<span class="text-red-600"> *</span>{% endif %}
        </label>

        <div>
          {{ field }}
        </div>

        {% if field.errors %}
          <p class="mt-1 text-sm text-red-600">
            {{ field.errors|striptags }}
          </p>
        {% endif %}

        {% if field.help_text %}
          <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
        {% endif %}
      </div>
    {% endfor %}

   
    {% if form.instance.pk and form.instance.image %}
      <div>
        <p class="text-sm text-gray-600 mb-2">Current image</p>
        <img src="{{ form.instance.image.url }}" alt="Current image" class="w-48 h-32 object-cover rounded-md border">
      </div>
    {% endif %}

    
    <div id="preview-wrapper" class="hidden">
      <p class="text-sm text-gray-600 mb-2">Preview</p>
      <img id="image-preview" src="#" alt="Image preview" class="w-48 h-32 object-cover rounded-md border">
    </div>

    <div class="flex items-center gap-3">
      <button
        type="submit"
        class="inline-flex items-center px-4 py-2 rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
      >
        {% if form.instance.pk %}Update{% else %}Create{% endif %}
      </button>

      <a href="{% url 'tweet_list' %}" class="text-sm text-gray-600 hover:underline">Cancel</a>
    </div>
  </form>
</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const fileInput = document.querySelector('input[type="file"]');
  const previewWrapper = document.getElementById('preview-wrapper');
  const previewImg = document.getElementById('image-preview');

  if (!fileInput) return;

  fileInput.addEventListener('change', function (e) {
    const file = e.target.files && e.target.files[0];
    if (!file) {
      previewWrapper.classList.add('hidden');
      previewImg.src = '#';
      return;
    }

    if (!file.type.startsWith('image/')) {
      previewWrapper.classList.add('hidden');
      previewImg.src = '#';
      return;
    }

    const reader = new FileReader();
    reader.onload = function (ev) {
      previewImg.src = ev.target.result;
      previewWrapper.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  });
});
</script>
{% endblock %}
